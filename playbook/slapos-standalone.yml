# This playbook will install slapos-node package and then slapproxy (with the
# "slapos configure local" command line). The combination of a slapnode and a
# slapproxy is a slapos standalone.

- name: SlapOS Standalone
  hosts: 127.0.0.1
  connection: local

  tasks:
    - name: Send the message to tell the test is success
      command: echo "Build successful, connect to:"
      register: build_msg

    - name: expose build message
      debug:
        msg="{{ build_msg }}"

    - name: Allow DNS
      iptables:
        action: append
        chain: OUTPUT
        protocol: udp
        destination_port: 53
        jump: ACCEPT

    - name: Allow to loopback and use localhost
      iptables:
        action: append
        chain: INPUT
        in_interface: lo
        jump: ACCEPT

    - name: Allow to use 10.0.X.X
      iptables:
        action: append
        chain: OUTPUT
        source: 10.0.0.0/16
        destination: 10.0.0.0/16
        jump: ACCEPT

    - name: Allow to use localhost
      iptables:
        action: append
        chain: INPUT
        source: 127.0.0.1
        destination: 127.0.0.1
        jump: ACCEPT

    - name: Allow to use localhost
      iptables:
        action: append
        chain: OUTPUT
        source: 127.0.0.1
        destination: 127.0.0.1
        jump: ACCEPT

    - name: Allow the inbound connection started by us
      iptables:
        action: append
        chain: INPUT
        match: conntrack
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: Allow to access nexedi.org
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination: www.nexedi.org
        destination_port: 80
        jump: ACCEPT

    - name: Allow to access shacache
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination: shacache.org
        destination_port: 80
        jump: ACCEPT

    - name: Allow to access nexedi.org HTTPS
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination: www.nexedi.org
        destination_port: 443
        jump: ACCEPT

    - name: Allow to access shacache HTTPS
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination: shacache.org
        destination_port: 443
        jump: ACCEPT

    - name: Change the goproxy in the hosts
      lineinfile:
        line: "120.221.249.220  goproxy.cn"
        dest: /etc/hosts

    - name: Change the goproxy.cn(qiniucs.com) in the hosts
      lineinfile:
        line: "47.246.44.230  s3-cn-south-1.qiniucs.com"
        dest: /etc/hosts

    - name: Change the rubygems/bundle in the hosts
      lineinfile:
        line: "2a04:4e42:600::483 rubygems.org"
        dest: /etc/hosts

    - name: Change the wxPython.org in the hosts
      lineinfile:
        line: "173.212.231.191  wxpython.org"
        dest: /etc/hosts

    - name: Change the lab.nexedi.com in the hosts
      lineinfile:
        line: "88.99.67.114 lab.nexedi.com"
        dest: /etc/hosts

    - name: Change the lab.nexedi.com in the hosts
      lineinfile:
        line: "212.129.18.209 lab.nexedi.com"
        dest: /etc/hosts

    - name: Allow to access lab.nexedi.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: lab.nexedi.com
        jump: ACCEPT

    - name: Allow to access gitlab.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: gitlab.com
        jump: ACCEPT

    - name: Allow to access lab.nexedi.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 80
        destination: lab.nexedi.com
        jump: ACCEPT

    # Allow to access github.com and raw.githubusercontent.com
    - name: Change the github.com in the hosts
      lineinfile:
        line: "140.82.121.3  github.com"
        dest: /etc/hosts

    # Allow to access gitlab.com, required by gitlab SR
    #    - name: Pin the gitlab.com in the hosts
    #      lineinfile:
    #        line: "172.65.251.78  gitlab.com"
    #        dest: /etc/hosts
    #
    #    - name: Allow to access gitlab.com
    #      iptables:
    #        action: append
    #        chain: OUTPUT
    #        protocol: tcp
    #        destination_port: 443
    #        destination: gitlab.com
    #        jump: ACCEPT

    - name: Allow to access github.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: github.com
        jump: ACCEPT

    - name: Allow to access github.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 80
        destination: github.com
        jump: ACCEPT

    - name: Allow to access raw.githubusercontent.com ipv4
      lineinfile:
        line: "185.199.110.133  githubusercontent.com"
        dest: /etc/hosts

    - name: Allow to access raw.githubusercontent.com ipv4
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: githubusercontent.com
        jump: ACCEPT

    - name: Allow to access githubusercontent.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 80
        destination: githubusercontent.com
        jump: ACCEPT

    - name: Allow to access raw.githubusercontent.com ipv6
      lineinfile:
        line: "2606:50c0:8003::154  raw.githubusercontent.com"
        dest: /etc/hosts

    - name: Allow to access raw.githubusercontent.com ipv6
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: raw.githubusercontent.com
        jump: ACCEPT

    - name: Allow to access raw.githubusercontent.com
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 80
        destination: raw.githubusercontent.com
        jump: ACCEPT
        
    # Default is storage.googleapis.com, use a differnt mirror to avoid potential impact
    - name: Allow to access npm.taobao.org/mirrors
      lineinfile:
        line: "114.55.80.225  npm.taobao.org"
        dest: /etc/hosts

    - name: Allow to access npmmirror.com
      lineinfile:
        line: "47.96.233.62  npmmirror.com"
        dest: /etc/hosts

    - name: Allow to access cdn.npmmirror.com
      lineinfile:
        line: "8.25.82.226  cdn.npmmirror.com"
        dest: /etc/hosts

    - name: Allow to access cdn.npmmirror.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: cdn.npmmirror.com
        jump: ACCEPT

    # You can see I allowed the default npmmirror regsitry too
    # This is because that is for the pure npm installation
    # Grafana buildout will call yarn manually, which will call storage.googleapis.com first,
    # to download the puppeteer, after that, it will use registry
    # For testing, I trying to avoid to connect google service.
    # So I download  puppeteer from another place,
    # which cause me to use same registry when call yarn manually.
    - name: Allow to access registry.npm.taobao.org
      lineinfile:
        line: "47.246.48.230  registry.npm.taobao.org"
        dest: /etc/hosts

    - name: Allow to access registry.npm.taobao.org
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: registry.npm.taobao.org
        jump: ACCEPT

    - name: Allow to access registry.npmmirror.org
      lineinfile:
        line: "47.246.24.230  registry.npmmirror.com"
        dest: /etc/hosts

    - name: Allow to access registry.npmmirror.org
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: registry.npmmirror.com
        jump: ACCEPT

    - name: Allow to access npm.taobao.org/mirrors
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: npm.taobao.org
        jump: ACCEPT

    - name: Allow to access npmmirror.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: npmmirror.com
        jump: ACCEPT

    - name: Allow to access raw.githubusercontent.com
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 80
        destination: raw.githubusercontent.com
        jump: ACCEPT

    - name: Allow to access wxpython.org
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: wxpython.org
        jump: ACCEPT

    - name: Allow to access rubygems/bundle
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: rubygems.org
        jump: ACCEPT

    - name: Allow to access goproxy.cn
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: goproxy.cn
        jump: ACCEPT

    - name: Allow to access qiniucs.com(goproxy.cn)
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: s3-cn-south-1.qiniucs.com
        jump: ACCEPT

    - name: Allow to access the service behind goproxy.cn
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: 47.246.44.226
        jump: ACCEPT

    - name: Change the codeload.github.com in the hosts
      lineinfile:
        line: "140.82.121.9  codeload.github.com"
        dest: /etc/hosts

    - name: Allow to access codeload.github.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: codeload.github.com
        jump: ACCEPT

    - name: Change the yarnpkg.com in the hosts
      lineinfile:
        line: "104.18.126.100  yarnpkg.com"
        dest: /etc/hosts

    - name: Allow to access yarnpkg.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: yarnpkg.com
        jump: ACCEPT

    - name: Change the classic.yarnpkg.com in the hosts
      lineinfile:
        line: "206.189.58.26  classic.yarnpkg.com"
        dest: /etc/hosts

    - name: Allow to access classsic.yarnpkg.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: classic.yarnpkg.com
        jump: ACCEPT

    # Workaround to allow to access registry.npmjs.org
    - name: Allow to access registry.npmjs.org
      lineinfile:
        line: "104.16.21.35  registry.npm.org"
        dest: /etc/hosts

    - name: Allow to access registry.npmjs.org
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: registry.npmjs.org
        jump: ACCEPT
        
    - name: Allow to access registry.npmjs.org
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 80
        destination: registry.npmjs.org
        jump: ACCEPT

    - name: Allow to access registry.npmjs.org
      lineinfile:
        line: "2606:4700::6810:1b23  registry.npm.org"
        dest: /etc/hosts

    - name: Allow to access registry.npmjs.org ipv6
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: registry.npmjs.org
        jump: ACCEPT

    - name: This is an IP behinde the taobao npm registry...
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: 8.48.85.1
        jump: ACCEPT

    # cypress using 2 steps of downloading
    # so set two entries in the hosts file
    - name: Allow to access download.cypress.io
      lineinfile:
        line: "104.26.6.176  download.cypress.io"
        dest: /etc/hosts

    - name: Allow to access cdn.cypress.io
      lineinfile:
        line: "104.26.6.176  cdn.cypress.io"
        dest: /etc/hosts

    - name: Allow to access cypress.io
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: cdn.cypress.io
        jump: ACCEPT
        
    # Open all ports on the IPv6 address
    - name: Allow to access ipv6 localhost with all ports
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: tcp
        destination: 2001:67c:1254:105:28ad::d94
        jump: ACCEPT

    # Needed by metabase caddy-frontend
    - name: Allow to access 2001:67c:1254:4::1/index.html
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: 2001:67c:1254:4::1
        jump: ACCEPT

    # This is for connect to the test suite and upload the test result.
    # You need to replace it with your own ERP5 instance domain s
    - name: Allow to access ERP5 test suite address
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: softinst144119.host.vifib.net
        jump: ACCEPT

    - name: Allow to access slap.vifib.com
      iptables:
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: slap.vifib.com
        jump: ACCEPT

    - name: Allow to access slap.vifib.com IPv6
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: tcp
        destination_port: 443
        destination: slap.vifib.com
        jump: ACCEPT

    - name: ACCEPT INPUT
      iptables:
        policy: ACCEPT
        chain: INPUT

    - name: DROP OUTPUT
      iptables:
        policy: DROP
        chain: OUTPUT

    # Incomming connection is not a problem for the shacache work
    - name: ACCEPT IPV6 INPUT
      iptables:
        ip_version: ipv6
        policy: ACCEPT
        chain: INPUT

    - name: DROP IPV6 OUTPUT
      iptables:
        ip_version: ipv6
        policy: DROP
        chain: OUTPUT

    - name: DROP IPV6 FORWARD
      iptables:
        ip_version: ipv6
        policy: DROP
        chain: FORWARD

    - name: Allow the inbound connection started by us
      iptables:
        ip_version: ipv6
        action: append
        chain: INPUT
        match: conntrack
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: Allow IPV6 input loopback
      iptables:
        ip_version: ipv6
        action: append
        chain: INPUT
        in_interface: lo
        jump: ACCEPT

    - name: Allow SSH IPV6 connection
      iptables:
        ip_version: ipv6
        action: append
        chain: INPUT
        match: tcp
        protocol: tcp
        destination_port: 22
        jump: ACCEPT

    - name: Allow INPUT IPV6 ICMP
      iptables:
        ip_version: ipv6
        action: append
        chain: INPUT
        protocol: ipv6-icmp
        jump: ACCEPT

    - name: Allow OUTPUT IPV6 ICMP
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        protocol: ipv6-icmp
        jump: ACCEPT

    - name: Allow OUTPUT conntrack
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        match: conntrack
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT

    - name: Reject all ipv4 output connect
      iptables:
        chain: OUTPUT
        table: filter
        jump: REJECT

    - name: Allow to use localhost
      iptables:
        ip_version: ipv6
        action: append
        chain: INPUT
        source: localhost
        destination: localhost
        jump: ACCEPT

    - name: Allow to use localhost
      iptables:
        ip_version: ipv6
        action: append
        chain: OUTPUT
        source: localhost
        destination: localhost
        jump: ACCEPT

    - name: Reject all ipv6 output connect
      iptables:
        ip_version: ipv6
        chain: OUTPUT
        table: filter
        jump: REJECT

    - name: Change the download-binary-cache-url
      lineinfile:
        path: /etc/opt/slapos/slapos.cfg
        regexp: download-binary-cache-url = http://shacache.nxdcdn.com
        line: download-binary-cache-url = http://shacache.org/shacache
        state: present
        backrefs: yes

    - name: Change the download-cache-url
      lineinfile:
        path: /etc/opt/slapos/slapos.cfg
        regexp: download-cache-url = http://shacache.nxdcdn.com
        line: download-cache-url = http://shacache.org/shacache
        state: present
        backrefs: yes

    - name: Change the download-binary-dir-url
      lineinfile:
        path: /etc/opt/slapos/slapos.cfg
        regexp: download-binary-dir-url = http://shadir.nxdcdn.com
        line: download-binary-dir-url = http://shacache.org/shadir
        state: present
        backrefs: yes

  roles:
    - slapos-proxy
