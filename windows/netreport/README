Net Resource Usage Report For Windows

Build extentions
================

$ python setup.py build

Test basic functions
====================

Maybe no test modules installed in the cygwin python. We need copy all
the test library files to python library path.

$ cd src
$ python tests.py

Here are example of src/Makefile:

PYTHON = /opt/slapos/bin/python

.PHONY : test

build: netuse.c
	(cd ..; $(PYTHON) setup.py build)

test: build
	$(PYTHON) tests.py


Then run test:

$ cd src
$ make test

Before test netreport.py,

$ easy_install lxml
$ ln -s /opt/git/slapos.core

Use Cases
=========

Slave Node
----------

Copy file "slapos-monitor", "netuse.dll" to /usr/sbin, create slapos-monitor.sh as the following:

    cat <<EOF > /usr/sbin/netdrive-monitor.sh
export PATH=/usr/local/bin:/bin:/sbin:$PATH
/usr/sbin/slapos-monitor
EOF
    chmod 711 /usr/sbin/netdrive-monitor.sh

then add a startup item for the domain user:

  * Logon as local administrator, run the following command in the cygwin terminal:

   username="The domain user name, it could be seen in the C:/Documents and Seetings"
   target=$(cygpath -w "/cygdrive/c/Documents and Settings/${username}/Start Menu/Programs/Startup/netdrive monitor.lnk")
   cat <<EOF > create_shortcut.vbs
 Set WshShell = WScript.CreateObject("WScript.Shell")
 strStartup = WshShell.SpecialFolders("Startup")
 Set oShellLink = WshShell.CreateShortcut("${target}")
 oShellLink.TargetPath = "$(cygpath -w /bin/mintty.exe)"
 oShellLink.Arguments = "-l /var/log/slap-monitor.log -w hide --exec /usr/sbin/netdrive-monitor.sh"
 oShellLink.WindowStyle = 1
 oShellLink.Description = "netdrive monitor"
 oShellLink.WorkingDirectory = "$(cygpath -w /usr/sbin)"
 oShellLink.Save
EOF
  cscript //B create_shortcut.vbs
  rm create_shortcut.vbs

If you don't want to add a shortcut, the second way is to add a startup item in the registry:

   * Login as domain user, and run the following command in the cygwin terminal:

   regtool set \\HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\slap-monitor \
               "$(cygpath -w /bin/mintty.exe) -l /var/log/slap-monitor.log -w hide --exec /usr/sbin/netdrive-monitor.sh"

   You want to remove the entry by 

   regtool unset \\HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\slap-monitor

   * In case the domain user have no right to change registry, then get sid first:

     mkpasswd -d

     It will list all the users in the current domain, find the expected sid, suppose it is "S-1-5-21-117609710-920026266-725345543-500", login as local administrator:

     regtool set \\HKU\\S-1-5-21-117609710-920026266-725345543-500\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\slap-monitor \
             "$(cygpath -w /bin/mintty.exe) -l /var/log/slap-monitor.log -w hide --exec /usr/sbin/netdrive-monitor.sh"

Master Node
-----------

Exchange Data Format
====================

Issues
======

1. Some records may be lost if the computer is shutdown in unnormal way.
