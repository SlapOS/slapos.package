<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE book SYSTEM "/usr/share/sgml/docbook/xml-dtd-4.1.2/docbookx.dtd">
<book>
<title>Using SlapOS in the Windows</title>
<bookinfo>
   <author>
      <firstname>Jondy</firstname>
      <surname>Zhao</surname>
   </author>
   <revhistory>
     <revision>
       <revnumber>0.5</revnumber>
       <date>2013-08-29</date>
       <authorinitials>Jondy Zhao - jondy.zhao@nexedi.com</authorinitials>
       <revremark>Add some packages when install cygwin; Change the steps of generating installer from source. </revremark>
     </revision>

     <revision>
       <revnumber>0.4</revnumber>
       <date>2013-08-01</date>
       <authorinitials>Jondy Zhao - jondy.zhao@nexedi.com</authorinitials>
       <revremark>Add chapter Create SlapOS Windows Installer Bootstrap Node.</revremark>
     </revision>

     <revision>
       <revnumber>0.3</revnumber>
       <date>2013-07-11</date>
       <authorinitials>Jondy Zhao - jondy.zhao@nexedi.com</authorinitials>
       <revremark>Add chapter SlapOS Sources Changed  For Windows.</revremark>
     </revision>
     <revision>
       <revnumber>0.2</revnumber>
       <date>2013-07-05</date>
       <authorinitials>Jondy Zhao - jondy.zhao@nexedi.com</authorinitials>
       <revremark>Add Cron Service and Know Issues section, fix some problems in the chapter Generating windows installer from sources.</revremark>
     </revision>
     <revision>
       <revnumber>0.1</revnumber>
       <date>2013-06-20</date>
       <authorinitials>Jondy Zhao - jondy.zhao@nexedi.com</authorinitials>
       <revremark>Create the document.</revremark>
     </revision>
   </revhistory>
</bookinfo>

<chapter id="ch_introduction"><title>Introduction</title>
<para>SlapOS can be described as a cloud operating system in which "everything is a process" unlike Unix in which "everything is a file". If one has to manage thousands of servers with thousands of processes, hundred different applications in multiple different releases or versions, SlapOS can help you a lot by making the whole management process well specified, automated and under control.</para>
<para>The goal of this tutorial is to teach how to use SlapOS in the windows.</para>
</chapter>

<chapter id="ch_install_slapos"><title>Installing SlapOS node in the Windows</title>
<para>At first, we need to sign up in VIFIB community Cloud by clicking here <ulink url="https://www.slapos.org/login_form"/></para>
<para>Then download the latest slapos windows installer from <ulink url="http://www.erp5.org/dists/installer"></ulink>, the filename of windows installer look like slapos-XXX-windows-YYY-all-in-one.exe or slapos-XXX-windows-YYY.exe, XXX stands for version-release information. YYY could be X86 or x64, the former means 32-bit, the latter 64-bit windows. The all-in-one installer include all the files required by slapos node, so it can run in the computer which doesn't access internat; the later will download most of packages from internet and build, so it need more time than all-in-one installer. It's recommanded to use the former installer in case of slow or unstable internet even if the size of all-in-one installer is more than 100MB, compare of the latter which size is about 2MB.</para>
<para>Double click the installer, click Next, Next ...
<note><para>If the current user isn't Administrator, you need run it as Administrator. Right click the installer, then click Run As Administrator.</para></note>
</para>
<para>At the final wizard page, click Install.</para>
<para>Waiting for everything done.</para>
<para>If you prefer to install slapos node from sources, refer to the chapter <xref linkend="ch_run_slapos_from_sources"/>.</para>
</chapter>

<chapter><title>Using Slapos in the Windows</title>
<para>After SlapOS has been installed successfully, you will find program group "SlapOS" which include the following entries:
<itemizedlist>
<listitem><para>Configure SlapOS</para></listitem>
<listitem><para>SlapOS Node</para></listitem>
<listitem><para>SlapOS</para></listitem>
<listitem><para>SlapOS Runner</para></listitem>
<listitem><para>Command Console</para></listitem>
<listitem><para>User Guide</para></listitem>
</itemizedlist>
</para>
<section id="sec_configure_slapos"><title>Configure SlapOS</title>
<para>It used to generate all the configure files required by slapos slave node, you can run it anytime when you need change the configure of your slapos slave node.</para>
<para>Go to slapos.org (or any other SlapOS Master), register if not already done, go to My Account and request an SSL certificate:
<itemizedlist>
<listitem><para>Copy the certificate in a file, save it in C:/slapos/cygwin/certificate</para></listitem>
<listitem><para>Copy the key in a file, save it in C:/slapos/cygwin/key</para></listitem>
</itemizedlist>
You can save them anywhere, but it's better to save them in the path C:/slapos/cygwin which is your slapos installed, because  it's the default path in the slapos configure script. </para>
<para>More information refer to <ulink url="http://community.slapos.org/wiki/osoe-Lecture.SlapOS.Extended/developer-Installing.SlapOS.Client"></ulink></para>
<para>Then register your computer to slapos.org community Cloud. By doing so, we will obtain X509 certificate and key which are later needed for the configuration process.
<itemizedlist>
<listitem><para>Login to www.slapos.org. Go to the "My Space" area and then to the "My Servers" section. Click on the button "New Server". This button will lead you to a page where you can specify the name of your server.</para></listitem>
<listitem><para>Enter a self contained name to identify your server. Consider a name "VIFIB 19 Asus i7 for JB" rather than "My Server". This will help you find your server later on. Click on the "Add" button.</para></listitem>
<listitem><para>X509 key and certificate are generated. Certificates are not stored by slapos.org server. They will be lost if you do not save them : Do not close this web page yet as we are going to store the key and certificate in files in next step. </para></listitem>
<listitem><para>Copy the certificate in a file, save it in C:/slapos/cygwin/computer.crt</para></listitem>
<listitem><para>Copy the key in a file, save it in C:/slapos/cygwin/computer.key</para></listitem>
</itemizedlist>
More information refer to <ulink url="http://community.slapos.org/wiki/osoe-Lecture.SlapOS.Extended/developer-Running.SlapOS.on.your.computer"></ulink> in the section VIFIB Registration.</para>
<para>Now it's time to run Configure SlapOS, click Start -> SlapOS -> Configure SlapOS, if the current user isn't Administrator, Right click Configure SlapOS, then Run As Administrator.</para>
<para>Or you can run configure script in the command line, first click Start -> SlapOS -> Command Console, if the current user isn't Administrator, Right click Command Console, then Run As Administrator, then in the command line:
<programlisting>
/etc/opt/slapos/scripts/slapos-configure.sh
</programlisting>
The configure script will guide you to configure slapos slave node, first, a super account "slaproot" will be created, you need type the password for this account
<programlisting>
*** Info: Please enter a password for new user slaproot.  Please be sure
*** Info: that this password matches the password rules given on your system.
*** Info: Entering no password will exit the configuration.
*** Query: Please enter the password:
*** Query: Reenter:
</programlisting>
Remember this password, it may be required when you run slapos configure again.
<programlisting>
</programlisting>
Next the configure script need certificate and key information:
<itemizedlist>
<listitem><para>Type computer certificate filename, if it's stored in the default path as above, type Enter directly</para></listitem>
<listitem><para>Type computer key filename, if it's stored in the default path as above, type Enter directly</para></listitem>
<listitem><para>Type client certificate filename, if it's stored in the default path as above, type Enter directly</para></listitem>
<listitem><para>Type client key filename, if it's stored in the default path as above, type Enter directly</para></listitem>
</itemizedlist>
Then waiting for configure script finished. Be sure the configure scrip report successfully, otherwise fix the problem and run it again. You can run Slapos Configure at anytime, and netx time you needn't input anything, configure scripts just checks all the configuration and update the configure files.
</para>
</section>

<section><title>SlapOS Node</title>
<para>It's used to create instance of slapos webrunner, format slapos node, release software and create instance, you an run it at any time.</para>
<para>Click Start -> SlapOS -> SlapOS Node, if the current user isn't Administrator, Right click SlapOS Node, then Run As Administrator.</para>
<para>Be sure the scrip reports successfully, otherwise fix the problem and run it again.</para>
</section>

<section><title>SlapOS</title>
<para>This is used by slapos client, now it's connected to <ulink url="https://www.slapos.org"/>. Logon and enjoy the journey in the SlapOS Cloud world.</para>
</section>

<section><title>SlapOS Runner</title>
<para>SlapOS Runner is a web based development tool which uses slapgrid to install the software, and it could be used to manage your slapos slave node in your computer.</para>
<para>After installing slapos, Node Runner isn't available. You need run SlapOS Node first. After that, Node Runner would be available.</para>
<para>Refer to <ulink url="http://community.slapos.org/wiki/osoe-Lecture.SlapOS.Extended/developer-Howto.Use.SlapOS.Web.Runner.html5"/></para>
</section>
<section><title>Command Console</title>
<para>It will open a terminal, here you can run most of slapos command, for examples,
<programlisting>
slapos node format -cv --now
slapos supply slaprunner COMP-1658
slapos request "Jondy Web Runner In Windows 7" slaposwebrunner --node computer_guid=COMP-1658
slapos node software
slapos node instance
slapos node status
</programlisting>
</para>
<para>For more information, refer to <ulink url="http://git.erp5.org/gitweb/slapos.core.git/blob/HEAD:/documentation/source/slapos.usage.rst?js=1"/></para>
</section>

<section><title>User Guide</title>
<para>It just shows this documnet in the web browser.</para>
</section>

<section><title>Cron Service</title>
<para>After run Configure SlapOS, a cron service will start in the background which used to release software and create instance periodically. Open Cygwin Terminal, type the following command to check cron jobs:
<programlisting>
# List all cron tabs
crontab -l
# Check cron works
tail /var/log/messages
# Edit cron tasks
crontab -e
# Stop cron
net stop cron
# Start cron
net start cron
</programlisting>
</para>
</section>

<section><title>Known issues</title>
<para>
<itemizedlist>
<listitem><para>Sometime cygwin service re6stnet cound't be stop by command "net stop", you need kill openvpn at first:
<programlisting>
TASKKILL /F /IM openvpn.exe
net stop re6stnet
rm -rf /var/lib/re6stnet
</programlisting>
Then you can start re6stnet again:
<programlisting>
net start re6stnet
</programlisting></para></listitem>
<listitem><para>If you're in non-english environment, be sure Cygwin Terminal works well in your own chareset. Click Start -> SlapOS -> Command Console, then
<programlisting>
netsh interface ipv6 show interface
</programlisting>
Check localize connection name show correctly. If not, maybe you need set environment variable "LANG" by command "ipwin" which is distributed with slapos windows installer. To be sure it's available. Type the following command:
<programlisting>
echo "LANG=C.$(ipwin codepage)" >> ~/.bashrc
tail ~/.bashrc
</programlisting>
Then restart your command terminal.
</para></listitem>
<listitem><para>Sometimes cygwin report remap errors, for example
<programlisting>
  0 [main] python2.7 3416 child_info_fork::abort: unable to remap _zope_interface_coptimizations.dll to same address as parent (0x450000) - try running rebaseall
  0 [main] python2.7 2332 child_info_fork::abort: unable to remap etree.dll to same address as parent (0x28B0000) - try running rebaseall
  0 [main] python2.7 3604 child_info_fork::abort: unable to remap _zope_interface_coptimizations.dll to same address as parent (0x450000) - try running rebaseall
</programlisting>
You need close all the cygwin box, and double click autorebase.bat in the C:/slapos-node/cygwin/autorebase.bat.
</para></listitem>
<listitem><para>Sometimes service re6stnet can't start, in this case, open cygwin terminal:
<programlisting>
rm -rf /var/lib/re6stnet
net start re6stnet
</programlisting>
</para></listitem>
</itemizedlist>
</para>
</section>
</chapter>

<chapter id="ch_generate_window_installer"><title>Generating windows installer from sources</title>
<para>This chapter describes how to generate windows installer from sources.</para>
<section id="sec_setup_cygwin"><title>Setting Up Cygwin</title>
<para>We need Cygwin environment in order to build slapos sources code in the Windows. </para>
<para>Go to <ulink url="http://cygwin.com/">"http://cygwin.com/"</ulink> and click on <ulink url="http://cygwin.com/setup-x86.exe">"setup-x86.exe"</ulink>. This will download a GUI installer called setup-x86.exe which can be run to download a complete cygwin installation via the internet. Follow the instructions on each screen to install Cygwin. </para>
<para>The Root Directory for Cygwin (default C:\cygwin) will become / within your Cygwin installation. You must have write access to the parent directory, and any ACLs on the parent directory will determine access to installed files.</para>
<para>By default, setup.exe will install only the packages in the Base category and their dependencies, resulting in a minimal Cygwin installation. We need choose the packages required by SlapOS, see <xref linkend="appendix_cygwin_packages"/>. Since setup.exe automatically selects dependencies, be careful not to unselect any required packages.</para>
<para>Refer to: <ulink url="http://cygwin.com/cygwin-ug-net/setup-net.html"/></para>
<para>Or you can install cygwin by command console, first you need download setup.exe from cygwin.com, save to D:\temp\setup.exe or somewhere else.
<itemizedlist>
<listitem><para>In the Windows destktop, Click Start</para></listitem>
<listitem><para>Click Run, type command: 'cmd', click OK to enter windows console. Be sure you start 'cmd' as Administrator, if the login user isn't Administrator, run 'cmd' as Administrator:</para></listitem>
<listitem><para>Type the following commands:<programlisting>
D:
MD slapos
CD slapos
SET PACKAGES=-P autobuild -P autoconf -P automake -P autossh -P binutils -P bison -P bzip2 -P ca-certificates -P cron -P curl -P cygport -P cygrunsrv -P file -P flex -P gcc4 -P gdbm -P libgdbm-devel -P gettext -P gettext-devel -P libglib2.0-devel -P libglib2.0_0 -P libexpat1 -P libexpat1-devel -P libmpfr-devel -P libmpfr4 -P libtool -P libxml2 -P libxml2-devel -P libxslt -P libxslt-devel -P make -P m4 -P libncurses-devel -P libncursesw-devel -P patch -P patchutils -P pkg-config -P python -P python-setuptools -P openssh -P openssl-devel -P libopenssl098 -P libopenssl100 -P popt -P readline -P libsqlite3-devel -P libsqlite3_0 -P swig -P syslog-ng -P zlib-devel -P vim -P wget -P libwrap-devel -P docbook-xsl -P docbook-xsl-ns -P mingw-gcc -P mingw64-i686-gcc -P mingw64-x86_64-gcc
MOVE d:\temp\setup.exe .\
setup.exe %PACKAGES% --no-verify -D -L -l D:\slapos\cygwin-packages -R D:\slapos\cygwin -s http://www.netgull.com/cygwin
</programlisting>Waiting for the installer finished.
<note><para>Some packages only used to build slapos from sources. Refer to <xref linkend="package-slapos-developer"/> to know more details.</para></note>
</para></listitem>
</itemizedlist>
A cygwin icon will be added in the windows desktop, click it to enter cygwin box. If the current user isn't Administrator, then right click cygwin icon, click Run As Administrator. Be suer you have enough rights to run the following commands:
<!--
You can create your script to start Cygwin in a tty terminal
<programlisting>
$ cat &lt;&lt;EOF  &gt; C:/cygwin/cygtty.bat
@echo off

C:
chdir C:\cygwin\bin

start mintty.exe -i /Cygwin-Terminal.ico -
</programlisting>
 -->
<programlisting>
sed -i -e "s/4\.3\.4/4.5.3/g" /usr/bin/libtool
[[ -f /etc/passwd ]] || mkpasswd > /etc/passwd
[[ -f /etc/group ]] || mkgroup > /etc/group
cp /etc/passwd /etc/passwd.orig
</programlisting>
Now we need patch cygport, otherwise we can't specify install path in the buildout.cfg:
<programlisting>
_filename=/usr/bin/cygport
if [[ -f ${_filename} ]] ; then
    echo Patching ${_filename} ...
    sed -i -e 's/D="${workdir}\/inst"/D="${CYGCONF_PREFIX-${workdir}\/inst}"/g' ${_filename} &amp;&amp;
    echo OK.
fi
_filename=/usr/share/cygport/cygclass/autotools.cygclass
if [[ -f ${_filename} ]] ; then
    echo Patching ${_filename} ...
    sed -i -e 's/prefix=$(__host_prefix)/prefix=${CYGCONF_PREFIX-$(__host_prefix)}/g' ${_filename} &amp;&amp;
    echo OK.
fi
_filename=/usr/share/cygport/cygclass/cmake.cygclass
if [[ -f ${_filename} ]] ; then
    echo Patching ${_filename} ...
    sed -i -e 's/-DCMAKE_INSTALL_PREFIX=$(__host_prefix)/-DCMAKE_INSTALL_PREFIX=${CYGCONF_PREFIX-$(__host_prefix)}/g' ${_filename} &amp;&amp;
    echo OK.
fi
</programlisting>
If you'd like to make the font of command box bigger
<programlisting>
cd ~
cat &lt;&lt;EOF  &gt; .minttyrc
BoldAsFont=no
Font=Courier New
FontHeight=16
Scrollbar=none
EOF
</programlisting>
Then restart cygwin command box.
<note><para>On Windows Vista or Windows 7, you need to run as administrator when launching the cygwin shell to allow the system configuration changes required in some of the steps below. You can configure cygwin to always launch with admin privileges if you wish.</para></note>
</para>
</section>

<section><title>Building SlapOS</title>
<para>Double click the desktop icon "Cygwin" to enter cygwin command box, the following commands are typed in this box.
<programlisting>
mkdir -p /opt/git
cd /opt/git
(cd slapos.package ; git pull) || git clone -b cygwin http://git.erp5.org/repos/slapos.package.git
cp /opt/git/slapos.package/windows/scripts/* /usr/local/bin
mkdir -p /opt/slapos/log
mkdir -p /opt/download-cache
cd /opt/slapos
echo "[buildout]
extends = http://git.erp5.org/gitweb/slapos.git/blob_plain/refs/heads/cygwin-share:/component/slapos/buildout.cfg
download-cache = /opt/download-cache
prefix = ${buildout:directory}
" > buildout.cfg
python -S -c 'import urllib2;print urllib2.urlopen("http://git.erp5.org/gitweb/slapos.core.git/blob_plain/HEAD:/bootstrap.py").read()' > bootstrap.py
python -S bootstrap.py
bin/buildout
</programlisting>
Now we need patch slapos.core for supporting cygwin, after these code are merged, it don't need.
<programlisting>
cd $(ls -d /opt/slapos/eggs/slapos.core-*.egg/)
_filename=/opt/git/slapos.package/windows/patches/slapos-core-format.patch
patch -f --dry-run -p1 &lt; ${_filename} &gt; /dev/null  &amp;&amp; patch -p1 &lt; ${_filename}
cd $(ls -d /opt/slapos/eggs/supervisor-*.egg/)
_filename=/opt/git/slapos.package/windows/patches/supervisor-cygwin.patch
cd supervisor
patch -f --dry-run -p1 &lt; ${_filename} &gt; /dev/null  &amp;&amp; patch -p1 &lt; ${_filename}
</programlisting>
If "slapos node" report "remap error", you need to do as the following,
<programlisting>
cd ~
find /opt/slapos -name "*.dll" &gt; /myfile.list
echo "PATH .\bin;%PATH%" &gt; /autorebase.bat
echo "dash /bin/rebaseall -T /myfile.list -v" &gt;&gt; /autorebase.bat
echo "EXIT 0" &gt;&gt; /autorebase.bat
echo "Pause" &gt;&gt; /autorebase.bat
exit
</programlisting>
After exit cygwin, double click autorebase.bat in the Windows explorer. If the current user isn't Administrator, then right click it, click Run As Administrator.
</para>
</section>

<section><title>Preparing the sources files for installer</title>
<para>Let's we start cygwin box, then clone slapos.package.git
<programlisting>
cd /opt
rm -rf slapos/slapos.tar.gz
tar czf slapos.tar.gz slapos/
mv slapos.tar.gz slapos/
</programlisting>
Generate regpwd.exe, which used to save user's password to registry:
<programlisting>
cd /opt/git/slapos.package/windows/scripts
gcc -o regpwd.exe regpwd.c
</programlisting>
Then build babeld for cygwin, we need use the sources in the slapos.package.git, they are patched for cygwin:
<programlisting>
cd /opt/git/slapos.package/windows/babeld
# WINVER could be XP, VISTA, WIN7, WIN8
WINVER=XP make
cp babeld.exe /usr/bin
</programlisting>
<!-- Now downlaod openvpn 2.3 for your window version, and install it. We need OpenVPN Tap-Windows Drivers files. -->
Now, build ipwin.exe which used to manage slapos network. If you have msvc build environments, build the solution "D:/slapos/opt/git/slapos.packages/windows/ipwin/ipwin.sln" as your perfer. If you have no idea about msvc, do as the following steps:
<itemizedlist>
<listitem><para>Install Microsoft Visual C++ 2008 Express Edition or later version, you can download package from <ulink url="http://www.microsoft.com/visualstudio/express"/>, it's free.</para></listitem>
<listitem><para>If you're running X64 environments, install Microsoft Windows SDK v7.0. You can download the package from <ulink url="http://download.microsoft.com/download/2/E/9/2E911956-F90F-4BFB-8231-E292A7B6F287/GRMSDKX_EN_DVD.iso"/>.</para></listitem>
<listitem><para>Double click D:/slapos/cygwin/opt/git/slapos.packages/windows/ipwin/ipwin/build.bat in the windows explorer, be sure there is no error. This script assumes your vcvarsall.bat installed at "C:\Program Files\Microsoft Visual Studio 9.0\VC\vcvarsall.bat", and  setenv.cmd installed at "C:\Program Files\Microsoft SDKs\Windows\v7.0\Bin\SetEnv.cmd" (required only for x64 platform), if not, please edit the script as your installed path.
<note><para>Don't run build.bat in the cygwin terminal, PROCESSOR_ARCHITECTURE maybe isn't right in the 64-bits architecture machine.</para></note></para></listitem>
</itemizedlist>
</para>
<para>
Then generate user-guide.html from using-slapos-in-windows.xml, generally you need not do this, just copy this file (you're looking now) to /opt/git/slapos.package/windows/docs. 
<programlisting>
cd /opt/git/slapos.package/windows/docs
# Before run make, be sure there is the file /usr/share/sgml/docbook/xsl-stylesheets/html/docbook.xsl, if not, find it first
# find /usr/share -name docbook.xsl
# Then replace the old file name with this one in the ./Makefile, then run make
make
</programlisting>
Download pyOpenSSL-0.13.tar.gz, miniupnpc-1.8.tar.gz,
<programlisting>
mkdir -p /opt/downloads
cd /opt/downloads
wget --no-check-certificate https://pypi.python.org/packages/source/p/pyOpenSSL/pyOpenSSL-0.13.tar.gz#md5=767bca18a71178ca353dff9e10941929
wget http://miniupnp.free.fr/files/download.php?file=miniupnpc-1.8.tar.gz -O miniupnpc-1.8.tar.gz
</programlisting>
Get re6stnet for cygwin
<programlisting>
cd /opt/git
(cd re6stnet ; git pull) || git clone -b cygwin http://git.erp5.org/repos/re6stnet.git

cd /opt/git/re6stnet/re6st
i686-w64-mingw32-gcc.exe ovpn-client.c ovpn-pipe.c -o ovpn-client.exe
i686-w64-mingw32-gcc.exe ovpn-server.c ovpn-pipe.c -o ovpn-server.exe

cd /opt/git/re6stnet
python setup.py sdist
</programlisting>
Get openvpn files, download official openvpn installer for your windows, for example, openvpn-install-2.3.2-I001-x86_64.exe for windows 7 64-bit, double click it to install openvpn, then:
<programlisting>
mkdir /opt/openvpn
cp -a /cygdrive/c/Program\ Files/OpenVPN/bin /opt/openvpn
cp -a /cygdrive/c/Program\ Files/OpenVPN/driver /opt/openvpn
cp -a /cygdrive/c/Program\ Files/TAP-Windows/driver /opt/openvpn
cp /cygdrive/c/Program\ Files/TAP-Windows/bin/devcon.exe /opt/openvpn/bin
</programlisting>
Get the icons files
<programlisting>
cd /opt
wget http://www.dashingsoft.com/products/slapos/images.tar.gz
tar xzf images.tar.gz --no-same-owner
</programlisting>
Get configure template file:
<programlisting>
wget http://git.erp5.org/gitweb/slapos.core.git/blob_plain/HEAD:/slapos.cfg.example -O /opt/slapos/slapos.cfg.example
wget http://git.erp5.org/gitweb/slapos.core.git/blob_plain/HEAD:/slapos-client.cfg.example -O /opt/slapos/slapos-client.cfg.example
</programlisting>
</para>
</section>

<section><title>Making installer</title>
<para>We use Inno-Setup sripts to genarate microsoft installer, so we need install inno setup first. You can download the installer from <ulink url="http://www.innosetup.com"/>, then install inno-setup in you computer</para>
<para>Then click Start -> Inno Setup 5 -> Inno Setup Compiler, to open inno setup.</para>
<para>In the inno setup window, click File -> Open, select the script: /opt/git/slapos.package/windows/scripts/slapos-all-in-one.iss</para>
<para>In the section "Setup", there are some options:
<itemizedlist>
<listitem><para>OutputDir: the generated installer will be saved here</para></listitem>
<listitem><para>OutputBaseFilename: the prefix of output installer</para></listitem>
<listitem><para>SourceDir: it's a very important option. It's the root path of all the relative path in the section "Files"</para></listitem>
</itemizedlist>
In the section "Files", to be sure all the source files are exsiting in your computer, for example
<programlisting>
Source: "images\slapos.ico"; DestDir: "{app}\cygwin\etc\slapos\images";
</programlisting>
Assum SourceDir in the section "Setup" is "D:\slapos", the builder will find "D:\slapos\images\slapos.ico" as the source, so this file should be exsited.
</para>
<para>Click menu Build -> Compile, then wait for the building process finished. You can check the installer in the OutputDir.</para>
<para>There is another script "slapos.iss", it used to build network installer. All-in-one installer will include all the files, so no internet connection required. However network installer need internet connection to download the files and packages. It's remarkable smaller than all-in-one installer.</para>
</section>
</chapter>

<chapter id="ch_run_slapos_from_sources"><title>Run SlapOS From Sources</title>
<para>This chapter describes how to run slapos slave node from sources in the windows.</para>
<para>First Setting Up Cygwin follow the instructions in the above chapter <xref linkend="sec_setup_cygwin"/></para>
<para>Next register to slapos community to get client and computer certificate and key files, refer to <xref linkend="sec_configure_slapos"/>.</para>
<para>Then run slapos-cygwin-bootstrap.sh, got it from slapos.package.git/windows/scripts</para>
<para>If there are some errors when run both of scripts, fix them and run again, until no any error reported, and now you can run any slapos command in this terminal.</para>
</chapter>

<chapter><title>SlapOS Sources Changed  For Windows</title>
<para>There are so many slapos sources changed for Windows. In the branch 'cygwin-share' in the slapos.git:
<itemizedlist>
<listitem><para>Change the buildout.cfg files for components, softwares and stack</para></listitem>
<listitem><para>Add patch files for building some component</para></listitem>
<listitem><para>Patch recipe slapos.cookbook</para></listitem>
</itemizedlist>
Re6stnet for windows:
<itemizedlist>
<listitem><para>Branch 'cygwin' in the re6stnet.git</para></listitem>
<listitem><para>Babeld package for cygwin, in branch 'cygwin' of slapos.package.git, location: windows/babeld</para></listitem>
<listitem><para>OpenVPN package for cygwin, in branch 'cygwin' of slapos.package.git, location: windows/openvpn</para></listitem>
</itemizedlist>
In the slapos.core.git:
<itemizedlist>
<listitem><para>Add branch 'cygwin'</para></listitem>
</itemizedlist>
In the slapos.package.git, add branch 'cygwin', it includes most of sources for cygwin:
<itemizedlist>
<listitem><para>babeld</para></listitem>
<listitem><para>docs</para></listitem>
<listitem><para>openvpn</para></listitem>
<listitem><para>netreport</para></listitem>
<listitem><para>ipwin</para></listitem>
<listitem><para>psutils</para></listitem>
<listitem><para>inotifyw</para></listitem>
<listitem><para>patches</para></listitem>
<listitem><para>scripts</para></listitem>
</itemizedlist>
</para>

<section><title>How to upgrade the sources</title>
<para>Update sources in the slapos.git, then push it</para>
<para>Update sources in the slapos.core.git, then push it</para>
<para>Update sources in the re6stnet.git, then push it</para>
<para>Update sources in the slapos.package.git, then push it.</para>
<para>Update egg psutil, for example, upgrade from 0.6.1 to 1.0.0,
<programlisting>
wget http://psutil.googlecode.com/files/psutil-1.0.0.tar.gz
tar xzf psutil-1.0.0.tar.gz
cd psutil-1.0.0
patch -p1 &lt; /opt/git/slapos.package/windows/patches/psutil-0.6.2.patch
# change the version to 1.0.1 in the psutil/__init__.py
python setup.py sdist
</programlisting>
Then upload the source packages dist/psutil-1.0.1.tar.gz to http://www.nexedi.org/static/packages/source/
</para>
<para>Update egg netifaces, same as psutil, except use patch file netifaces-0.8-1-cygwin.patch</para>
</section>

<section><title>How to upgrade installer</title>
<para>Redo all the action in the chapter Generate Installer For Windows</para>
</section>

<section><title>Merge sources to master branch</title>
<para>merge cygwin to master in the slapos.core.git</para>
<para>merge cygwin to master in the slapos.package.git</para>
<para>merge cygwin-share to master in the slapos.git</para>
<para>merge cygwin to master in the re6stnet.git</para>
</section>
</chapter>

<chapter><title>Create SlapOS Windows Installer Bootstrap Node</title>
<para>This chapter descripts how to create a slapos node in the windows which used to test the windows installer self:
<itemizedlist>
<listitem><para>Install cygwin</para></listitem>
<listitem><para>Prepare certificate, key, computer.key, computer.crt</para></listitem>
<listitem><para>Run slapos-cygwin-bootstrap.sh, got it from slapos.package.git/windows/scripts</para></listitem>
<listitem><para>Run command slapos node software/release until instance created</para></listitem>
<listitem><para>Run command slapos remove to destroy this instance</para></listitem>
</itemizedlist>
</para>

<section><title>Add SlapOS Bootstrap Node to Vifib Cluster</title>
<para>Create an instance of SlapOS Test-Agent in slapos bootstrap node (computer.key/computer.crt), it will test the software: http://git.erp5.org/gitweb/slapos.git/blob_plain/refs/heads/cygwin-share:/software/slapos-windows-installer/software.cfg, this software can build slapos windows installer, then run the installer to create a slapos test node.</para>
<para>Create another instance of SlapOS Test-Agent used to test the instances running in the slapos test node (test-computer.key/test-computer.crt). This test agent can include any software which can run in the slapos windows.</para>
</section>
</chapter>

<appendix id="appendix_cygwin_packages"><title>Cygwin Required Packages List</title>
<para>The following packages are requied by SlapOS Node
<itemizedlist>
<listitem><para>Devel/autobuild</para></listitem>
<listitem><para>Devel/autoconf</para></listitem>
<listitem><para>Devel/automake</para></listitem>
<listitem><para>Net/autossh</para></listitem>
<listitem><para>Devel/binutils</para></listitem>
<listitem><para>Devel/bison</para></listitem>
<listitem><para>Utils/bzip2<superscript></superscript></para></listitem>
<listitem><para>Net/ca-certificates</para></listitem>
<listitem><para>Admin/cron</para></listitem>
<listitem><para>Net/curl</para></listitem>
<listitem><para>Devel/cygport</para></listitem>
<listitem><para>Admin/cygrunsrv</para></listitem>
<listitem><para>Utils/file<superscript>*</superscript></para></listitem>
<listitem><para>Devel/flex</para></listitem>
<listitem><para>Devel/gcc4</para></listitem>
<listitem><para>Utils/gdbm</para></listitem>
<listitem><para>Devel/libgdbm-devel</para></listitem>
<listitem><para>Devel/gettext<superscript>*</superscript></para></listitem>
<listitem><para>Devel/gettext-devel</para></listitem>
<listitem><para>Devel/git</para></listitem>
<listitem><para>GNOME/libglib2.0-devel</para></listitem>
<listitem><para>GNOME/libglib2.0_0</para></listitem>
<listitem><para>Libs/libexpat1</para></listitem>
<listitem><para>Libs/libexpat1-devel</para></listitem>
<listitem><para>Libs/libmpfr-devel</para></listitem>
<listitem><para>Libs/libmpfr4</para></listitem>
<listitem><para>Libs/libsqlite3-devel</para></listitem>
<listitem><para>Libs/libsqlite3_0</para></listitem>
<listitem><para>Devel/libtool</para></listitem>
<listitem><para>Devel/libwrap-devel</para></listitem>
<listitem><para>Libs/libxml2</para></listitem>
<listitem><para>Libs/libxml2-devel</para></listitem>
<listitem><para>Libs/libxslt</para></listitem>
<listitem><para>Libs/libxslt-devel</para></listitem>
<listitem><para>Devel/make</para></listitem>
<listitem><para>Interpreters/m4</para></listitem>
<listitem><para>Devel/libncurses-devel</para></listitem>
<listitem><para>Devel/libncursesw-devel</para></listitem>
<listitem><para>Utils/patch</para></listitem>
<listitem><para>Utils/patchutils</para></listitem>
<listitem><para>Devel/pkg-config</para></listitem>
<listitem><para>Python/python<superscript>2.7</superscript></para></listitem>
<listitem><para>Python/python-openssl</para></listitem>
<listitem><para>Python/python-setuptools</para></listitem>
<listitem><para>Net/openssh</para></listitem>
<listitem><para>Devel/openssl-devel</para></listitem>
<listitem><para>Libs/libopenssl098</para></listitem>
<listitem><para>Libs/libopenssl100</para></listitem>
<listitem><para>Libs/popt</para></listitem>
<listitem><para>Devel/readline<superscript>*</superscript></para></listitem>
<listitem><para>Database/sqlite3</para></listitem>
<listitem><para>Devel/swig</para></listitem>
<listitem><para>Admin/syslog-ng</para></listitem>
<listitem><para>Devel/zlib-devel</para></listitem>
<listitem><para>Editor/vim</para></listitem>
<listitem><para>Web/wget</para></listitem>
</itemizedlist>
<note id="package-slapos-developer"><para>
The following packages only used to build slapos from sources, they are not required by slapos runtime.
<itemizedlist>
<listitem><para>Devel/mingw-gcc</para></listitem>
<listitem><para>Devel/mingw64-i686-gcc</para></listitem>
<listitem><para>Devel/mingw64-x86_64-gcc</para></listitem>
<listitem><para>Text/docbook-xsl</para></listitem>
<listitem><para>Text/docbook-xsl-ns</para></listitem>
</itemizedlist>
</para></note>
</para>
<!--
<para>
The following packages are requied by re6stnet
<itemizedlist>
<listitem><para>openvpn<superscript>#</superscript></para></listitem>
<listitem><para>babeld<superscript>#</superscript></para></listitem>
</itemizedlist>
</para>
<para>The following packages are requied by wamp
<itemizedlist>
<listitem><para>Web/apache2</para></listitem>
<listitem><para>Web/apache2-devel</para></listitem>
<listitem><para>apache2-php<superscript>#</superscript></para></listitem>
<listitem><para>Devel/cmake</para></listitem>
<listitem><para>Libs/libbz2-devel</para></listitem>
<listitem><para>Net/libcurl-devel</para></listitem>
<listitem><para>Text/libenchant-devel</para></listitem>
<listitem><para>Text/libenchant1</para></listitem>
<listitem><para>X11/libfreetype-devel</para></listitem>
<listitem><para>X11/libfreetype6</para></listitem>
<listitem><para>Devel/libjpeg-devel</para></listitem>
<listitem><para>Libs/libjpeg8</para></listitem>
<listitem><para>Devel/libpng-devel</para></listitem>
<listitem><para>Libs/libpng15</para></listitem>
<listitem><para>X11/libXpm-devel</para></listitem>
<listitem><para>X11/libXpm4</para></listitem>
<listitem><para>dropbear<superscript>#</superscript></para></listitem>
<listitem><para>logrotate<superscript>#</superscript></para></listitem>
<listitem><para>mariadb<superscript>#</superscript></para></listitem>
<listitem><para>Utils/rdiff-backup</para></listitem>
<listitem><para>Net/stunnel</para></listitem>
</itemizedlist>
'*' means it's default package of cygwin, '#' means it need to build by myself, '?' means maybe it's not required.
</para>
 -->
</appendix>
</book>
